---
title: "Posterprojekt: Anaconda – Path 1"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(digits = 4)
library(ggplot2)
library(MASS)
library(mvnormtest)
library(car)
```

### 1. Data og forberedelse

```{r}
data("T6-19", package = "st514")
T6.19 <- tbl
colnames(T6.19) <- c("Snout Vent Length (cm)", "Weight (kg)", "Gender")
levels(T6.19$Gender) <- c("Female", "Male")
head(T6.19)
```

---

### 2. Exploratory Data Analysis (EDA)

```{r}
summary(T6.19)
boxplot(`Snout Vent Length (cm)` ~ Gender, data = T6.19)
boxplot(`Weight (kg)` ~ Gender, data = T6.19)
ggplot(T6.19, aes(x = `Snout Vent Length (cm)`, y = `Weight (kg)`, color = Gender)) +
  geom_point(size = 2) + theme_minimal()
```

```{r}
qqPlot(T6.19$`Snout Vent Length (cm)`[T6.19$Gender == "Female"])
qqPlot(T6.19$`Weight (kg)`[T6.19$Gender == "Female"])
qqPlot(T6.19$`Snout Vent Length (cm)`[T6.19$Gender == "Male"])
qqPlot(T6.19$`Weight (kg)`[T6.19$Gender == "Male"])
```

```{r}
plot(density(T6.19$`Snout Vent Length (cm)`), main = "Density - Snout")
curve(dnorm(x, mean = mean(T6.19$`Snout Vent Length (cm)`),
             sd = sd(T6.19$`Snout Vent Length (cm)`)),
      add = TRUE, col = "red")

plot(density(T6.19$`Weight (kg)`), main = "Density - Weight")
curve(dnorm(x, mean = mean(T6.19$`Weight (kg)`),
             sd = sd(T6.19$`Weight (kg)`)),
      add = TRUE, col = "red")
```

```{r}
X <- T6.19[, 1:2]
mu <- colMeans(X)
S <- cov(X)
D2 <- mahalanobis(X, mu, S)
qqPlot(D2, main = "Mahalanobis D² QQ-Plot")
```

---

### 3. Univariate T-tests

```{r}
t.test(`Snout Vent Length (cm)` ~ Gender, data = T6.19, var.equal = TRUE)
t.test(`Weight (kg)` ~ Gender, data = T6.19, var.equal = TRUE)
```

---

### 4. Hotelling’s T² Test

```{r}
Xf <- T6.19[T6.19$Gender == "Female", 1:2]
Xm <- T6.19[T6.19$Gender == "Male", 1:2]
n1 <- nrow(Xf); n2 <- nrow(Xm)
xbar1 <- colMeans(Xf); xbar2 <- colMeans(Xm)
S1 <- cov(Xf); S2 <- cov(Xm)
Spooled <- ((n1 - 1)*S1 + (n2 - 1)*S2) / (n1 + n2 - 2)
T2 <- t(xbar1 - xbar2) %*% solve((1/n1 + 1/n2)*Spooled) %*% (xbar1 - xbar2)
p <- ncol(Xf)
Fstat <- (n1 + n2 - p - 1)*T2 / ((n1 + n2 - 2)*p)
pval <- 1 - pf(Fstat, df1 = p, df2 = n1 + n2 - p - 1)
T2; Fstat; pval
```

---

### 5. Box’s M Test (manuelt)

```{r}
logdet_S1 <- log(det(S1))
logdet_S2 <- log(det(S2))
logdet_pooled <- log(det(Spooled))
M <- (n1 - 1) * logdet_S1 + (n2 - 1) * logdet_S2 - (n1 + n2 - 2) * logdet_pooled
u <- (1/(n1 - 1) + 1/(n2 - 1) - 1/(n1 + n2 - 2)) * ((2*p^2 + 3*p - 1)/(6*(p + 1)*(2 - 1)))
C <- (1 - u)*M
df_boxm <- p*(p + 1)/2
pval_boxm <- 1 - pchisq(C, df_boxm)
C; pval_boxm
```

---

### 6. Simultane Konfidensintervaller og Ellipseplot

```{r}
alpha <- 0.05
tval <- qt(1 - alpha / (2 * p), df = n1 + n2 - 2)
se_diff <- sqrt(diag((1/n1 + 1/n2)*Spooled))
diff_means <- xbar1 - xbar2
lower <- diff_means - tval * se_diff
upper <- diff_means + tval * se_diff
cbind(lower, upper)
```

```{r}
# Confidence Ellipse
x_seq <- seq(diff_means[1] - 5, diff_means[1] + 5, length = 100)
y_seq <- seq(diff_means[2] - 5, diff_means[2] + 5, length = 100)
grid <- expand.grid(x_seq, y_seq)
fval <- matrix(apply(grid, 1, function(mu) {
  t(mu - diff_means) %*% solve((1/n1 + 1/n2)*Spooled) %*% (mu - diff_means)
}), nrow = 100)

T2_crit <- (n1 + n2 - 2)*p/(n1 + n2 - p - 1) * qf(1 - alpha, df1 = p, df2 = n1 + n2 - p - 1)

contour(x_seq, y_seq, fval, levels = T2_crit, drawlabels = FALSE,
        xlab = "Snout Length Diff", ylab = "Weight Diff",
        main = "Confidence Ellipse with Bonferroni CI")
abline(v = lower[1], lty = 2); abline(v = upper[1], lty = 2)
abline(h = lower[2], lty = 2); abline(h = upper[2], lty = 2)
points(diff_means[1], diff_means[2], pch = 19)
```

---

### 7. Konklusion og Fortolkning

- Signifikant forskel i længde (Hotelling's T² + Bonferroni)
- Ingen signifikant forskel i vægt (Bonferroni CI inkluderer 0)
- Box’s M test viser, at kovariansmatricerne kan betragtes som ens

➡️ Anaconda-hunnerne er generelt længere end hannerne – vægtmæssigt er forskellen usikker.
