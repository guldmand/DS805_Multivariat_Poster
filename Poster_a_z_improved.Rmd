---
title: "Posterprojekt: Anaconda – Path 1"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(digits = 4)
library(st514)
library(ggplot2)
library(MASS)
library(car)
library(ellipse)
library(mvnormtest)
```

### 1. Exploratory Data Analysis (EDA)

```{r}
data("T6-19", package = "st514")
T6.19 <- tbl
colnames(T6.19) <- c("Snout Vent Length (cm)", "Weight (kg)", "Gender")
levels(T6.19$Gender) <- c("Female", "Male")
summary(T6.19)
```

#### Boxplots og Scatterplot
```{r}
boxplot(`Snout Vent Length (cm)` ~ Gender, data = T6.19)
boxplot(`Weight (kg)` ~ Gender, data = T6.19)
ggplot(T6.19, aes(x = `Snout Vent Length (cm)`, y = `Weight (kg)`, color = Gender)) +
  geom_point(size = 2) + theme_minimal()
```

#### QQ-plots (Univariat normalitet)
```{r}
qqPlot(T6.19$`Snout Vent Length (cm)`[T6.19$Gender == "Female"], main = "QQ: Length Female")
qqPlot(T6.19$`Snout Vent Length (cm)`[T6.19$Gender == "Male"], main = "QQ: Length Male")
qqPlot(T6.19$`Weight (kg)`[T6.19$Gender == "Female"], main = "QQ: Weight Female")
qqPlot(T6.19$`Weight (kg)`[T6.19$Gender == "Male"], main = "QQ: Weight Male")
```

#### Multivariat normalitetstest (Mahalanobis D^2)
```{r}
X <- T6.19[, 1:2]
mu <- colMeans(X)
S <- cov(X)
D2 <- mahalanobis(X, mu, S)
qqPlot(D2, main = "QQ-plot af Mahalanobis D²")
```

---

### 2. Univariate t-tests
```{r}
t.test(`Snout Vent Length (cm)` ~ Gender, data = T6.19, var.equal = TRUE)
t.test(`Weight (kg)` ~ Gender, data = T6.19, var.equal = TRUE)
```

---

### 3. Hotelling’s T² og Box’s M test
```{r}
Xf <- T6.19[T6.19$Gender == "Female", 1:2]
Xm <- T6.19[T6.19$Gender == "Male", 1:2]
n1 <- nrow(Xf); n2 <- nrow(Xm)
xbar1 <- colMeans(Xf); xbar2 <- colMeans(Xm)
S1 <- cov(Xf); S2 <- cov(Xm)
Spooled <- ((n1 - 1)*S1 + (n2 - 1)*S2) / (n1 + n2 - 2)
T2 <- t(xbar1 - xbar2) %*% solve((1/n1 + 1/n2)*Spooled) %*% (xbar1 - xbar2)
p <- ncol(Xf)
Fstat <- (n1 + n2 - p - 1)*T2 / ((n1 + n2 - 2)*p)
pval <- 1 - pf(Fstat, df1 = p, df2 = n1 + n2 - p - 1)
T2; Fstat; pval

# Box’s M
logdet_S1 <- log(det(S1))
logdet_S2 <- log(det(S2))
logdet_pooled <- log(det(Spooled))
M <- (n1 - 1)*logdet_S1 + (n2 - 1)*logdet_S2 - (n1 + n2 - 2)*logdet_pooled
u <- (1/(n1 - 1) + 1/(n2 - 1) - 1/(n1 + n2 - 2)) * ((2*p^2 + 3*p - 1)/(6*(p + 1)))
Chi2 <- M * (1 - u)
df_boxm <- p * (p + 1) / 2
pval_boxm <- 1 - pchisq(Chi2, df = df_boxm)
Chi2; pval_boxm
```

---

### 4. Simultane konfidensintervaller og ellipse
```{r}
diff_mean <- xbar1 - xbar2
n <- (n1 * n2) / (n1 + n2)
alpha <- 0.05
T2_crit <- ((n1 + n2 - 2) * p / (n1 + n2 - p - 1)) * qf(1 - alpha, p, n1 + n2 - p - 1)

bonf_tval <- qt(1 - alpha / (2 * p), df = n1 + n2 - 2)
cimu1 <- diff_mean[1] + c(-1, 1) * bonf_tval * sqrt(Spooled[1, 1] / n)
cimu2 <- diff_mean[2] + c(-1, 1) * bonf_tval * sqrt(Spooled[2, 2] / n)

xlim <- range(c(0, cimu1)) * c(0.8, 1.2)
ylim <- range(c(0, cimu2)) * c(0.8, 1.2)

plot(ellipse(Spooled / n, centre = diff_mean, level = 1 - alpha, t = sqrt(T2_crit)),
     type = "l", xlab = "Snout Length", ylab = "Weight",
     main = "Hotelling's T² Ellipse + Bonferroni CI",
     xlim = xlim, ylim = ylim)
points(0, 0, pch = 3, col = "blue")
points(diff_mean[1], diff_mean[2], pch = 19, col = "darkred")
lines(c(cimu1[1], cimu1[1]), c(cimu2[1], cimu2[2]), lty = 2)
lines(c(cimu1[2], cimu1[2]), c(cimu2[1], cimu2[2]), lty = 2)
lines(c(cimu1[1], cimu1[2]), c(cimu2[1], cimu2[1]), lty = 2)
lines(c(cimu1[1], cimu1[2]), c(cimu2[2], cimu2[2]), lty = 2)
```

---

### 5. Konklusion og fortolkning

- **Univariat**: Signifikant forskel i længde (p < 0.05), vægt marginal
- **Multivariat**: Hotelling’s T²-test viser signifikant forskel i middelvektorer
- **Simultane CI’er**: Kun CI for vægt inkluderer 0 → længde driver forskellen
- **Box’s M test**: Antagelse om fælles kovariansmatrice virker rimelig (p > 0.05)
- **Biologisk betydning**: Hunner er signifikant længere, vægtforskellen er usikker
- **Antagelser**: Normalitet (univariat og Mahalanobis) er visuelt rimelige
