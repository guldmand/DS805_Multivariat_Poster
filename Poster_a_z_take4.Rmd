---
title: "Posterprojekt: Anaconda – Path 1"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(digits = 4)
library(ggplot2)
library(MASS)
library(mvnormtest)
library(car)
```

### 1. Data og forberedelse

```{r}
library(st514)
data("T6-19", package = "st514")
T6.19 <- tbl
colnames(T6.19) <- c("Snout Vent Length (cm)", "Weight (kg)", "Gender")
levels(T6.19$Gender) <- c("Female", "Male")
head(T6.19)
```

---

### 2. Exploratory Data Analysis (EDA)

```{r}
# Sammendrag
summary(T6.19)

# Boxplots
boxplot(`Snout Vent Length (cm)` ~ Gender, data = T6.19, col = c("pink", "lightblue"))
boxplot(`Weight (kg)` ~ Gender, data = T6.19, col = c("pink", "lightblue"))

# Scatterplot
ggplot(T6.19, aes(x = `Snout Vent Length (cm)`, y = `Weight (kg)`, color = Gender)) +
  geom_point(size = 2) + theme_minimal()
```

```{r}
# QQ-plots for hver gruppe og variabel
qqPlot(T6.19$`Snout Vent Length (cm)`[T6.19$Gender == "Female"], main = "QQ: Snout (Female)")
qqPlot(T6.19$`Snout Vent Length (cm)`[T6.19$Gender == "Male"], main = "QQ: Snout (Male)")
qqPlot(T6.19$`Weight (kg)`[T6.19$Gender == "Female"], main = "QQ: Weight (Female)")
qqPlot(T6.19$`Weight (kg)`[T6.19$Gender == "Male"], main = "QQ: Weight (Male)")
```

```{r}
# Tæthedskurver
sn <- T6.19$`Snout Vent Length (cm)`
wt <- T6.19$`Weight (kg)`
plot(density(sn), main = "Tæthedskurve - Snout")
curve(dnorm(x, mean(sn), sd(sn)), col = "red", add = TRUE)
plot(density(wt), main = "Tæthedskurve - Weight")
curve(dnorm(x, mean(wt), sd(wt)), col = "red", add = TRUE)
```

```{r}
# Multivariat normalitet med Mahalanobis afstand
X <- T6.19[, 1:2]
x_bar <- colMeans(X)
S <- cov(X)
D2 <- mahalanobis(X, x_bar, S)
qqPlot(D2, main = "QQ-plot af Mahalanobis D²")
```

---

### 3. Univariate T-tests

```{r}
t.test(`Snout Vent Length (cm)` ~ Gender, data = T6.19, var.equal = TRUE)
t.test(`Weight (kg)` ~ Gender, data = T6.19, var.equal = TRUE)
```

---

### 4. Hotelling’s T² Test

```{r}
Xf <- T6.19[T6.19$Gender == "Female", 1:2]
Xm <- T6.19[T6.19$Gender == "Male", 1:2]
n1 <- nrow(Xf); n2 <- nrow(Xm)
xbar1 <- colMeans(Xf); xbar2 <- colMeans(Xm)
S1 <- cov(Xf); S2 <- cov(Xm)
Spooled <- ((n1 - 1)*S1 + (n2 - 1)*S2) / (n1 + n2 - 2)
T2 <- t(xbar1 - xbar2) %*% solve((1/n1 + 1/n2)*Spooled) %*% (xbar1 - xbar2)
p <- ncol(Xf)
Fstat <- (n1 + n2 - p - 1)*T2 / ((n1 + n2 - 2)*p)
pval <- 1 - pf(Fstat, df1 = p, df2 = n1 + n2 - p - 1)
T2; Fstat; pval
```

---

### 5. Box’s M Test (manual, jf. slides)

```{r}
logdet_S1 <- log(det(S1))
logdet_S2 <- log(det(S2))
logdet_pooled <- log(det(Spooled))
M <- (n1 - 1) * logdet_S1 + (n2 - 1) * logdet_S2 - (n1 + n2 - 2) * logdet_pooled

g <- 2
u <- (1/(n1 - 1) + 1/(n2 - 1) - 1/(n1 + n2 - 2)) * ((2*p^2 + 3*p - 1)/(6*(p + 1)*(g - 1)))
C <- (1 - u)*M
df_boxm <- p*(p + 1)/2
pval_boxm <- 1 - pchisq(C, df_boxm)
C; pval_boxm
```

---

### 6. Simultane Bonferroni Confidence Intervals

```{r}
alpha <- 0.05
tval <- qt(1 - alpha / (2 * p), df = n1 + n2 - 2)
se_diff <- sqrt(diag((1/n1 + 1/n2)*Spooled))
diff_means <- xbar1 - xbar2
lower <- diff_means - tval * se_diff
upper <- diff_means + tval * se_diff
cbind(lower, upper)
```

```{r}
# Plot Bonferroni CI
ci_data <- data.frame(
  Variable = c("Snout", "Weight"),
  Lower = lower,
  Upper = upper
)

ggplot(ci_data, aes(x = Variable, ymin = Lower, ymax = Upper)) +
  geom_errorbar(width = 0.2) +
  geom_point(aes(y = diff_means), shape = 18, size = 3) +
  theme_minimal() +
  labs(title = "Bonferroni CI for Mean Differences")
```

---

### 7. Konklusion og fortolkning

* **Hotelling’s T²**: Signifikant forskel mellem hanner og hunner ($p \ll 0.05$)
* **Box’ M-test**: Kovariansmatricerne kan **ikke** antages ens ($p \approx 1$)
* **Simultane CI’er**:
  - Længde CI udelukker 0 → signifikant forskel
  - Vægt CI inkluderer 0 → ikke signifikant

➡️ Forskellen mellem hanner og hunner skyldes primært længde, ikke vægt.

---

### 8. Antagelser

* Multivariat normalitet tjekket visuelt + Mahalanobis
* Uafhængige stikprøver
* CI og T² er robuste i små samples ifm. praktisk analyse
